# java并发编程的艺术
## 第一章重点内容

#### 1.上下文切换
CPU通过时间片分配算法来执行任务，执行完一个时间片后会切换下一个任务，并且**切换前会保存上一个任务的状态**，以便下次切换回这个任务时，能够再加载这个任务的状态。
**任务从保存到再加载的过程就是一次上下文切换**，多线程竞争锁时，会引起上下文切换
#### 2.如何减少上下文切换
* 无锁并发编程，如将数据的ID按照**Hash算法取模分段**，不同的线程处理不同段的数据
* **CAS**算法，java的Atomic包使用CAS算法更新数据，而不需要加锁(下一章我会介绍)
* 避免创建不需要的线程，防止大量线程处于等待状态(在JBOSS的线程池配置中将maxThreads降低)
* 协程：在单线程中实现多任务调度，并在单线程中维持多个任务的切换

#### 3.多线程不一定比单线程快，因为线程有创建和上下文切换的开销

#### 4.避免死锁(两线程互相等待对方释放锁)的几个常见方法
* 避免一个线程同时获取多个锁
* 避免一个线程在锁内同时获取多个资源，**尽量保证一个锁只占用一个资源**
* 尝试使用定时锁，用**lock.trylock(timeout)**
* 对于数据库锁，加锁和解锁**必须要在一个数据库连接里**，否则会出现解锁失败的情况

####  5.资源限制
* 并发编程时执行速度受限于硬件或软件资源，硬件资源比如服务器带宽，下载速度，软件资源有数据库的连接数和socket连接数
* 受限于资源，多线程可能会更慢
#### 6.如何解决资源限制
* 硬件资源限制可以使用**集群**并行执行,比如ODPS，Hadoop，自己搭建的服务器集群，可以使用**数据ID%机器数**得到计算机编号然后由对应的计算机处理该数据
* 软件资源限制考虑**资源复用**，使用**连接池**将数据库和Socket复用,或者在**调用对方webservice接口**获取数据时，**只建立一个连接**
* 当然在资源限制情况下我们也能进行并发编程，我们得根据不同资源的限制调整资源的并发度。举个例子：与数据库数据交互时，如果SQL语句执行很快，线程的数量就比数据库连接数多很多，那样某些线程就会阻塞，因为要等待数据库连接

### 用JDK并发包提供的东西可以解决上述的一些并发问题，后续探讨
